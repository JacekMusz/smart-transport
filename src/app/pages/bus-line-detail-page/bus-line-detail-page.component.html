<div class="page-wrapper">
  <div class="page-container">
    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading && !notFound">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>≈Åadowanie danych z localStorage...</p>
      </div>
    </div>

    <!-- Not Found State -->
    <div class="not-found" *ngIf="notFound">
      <div class="not-found-content">
        <h1>Linia nie znaleziona</h1>
        <p>Nie mo≈ºna znale≈∫ƒá linii o podanym ID.</p>
        <button class="btn-primary" (click)="goBack()">
          ‚Üê Powr√≥t do listy linii
        </button>
      </div>
    </div>

    <!-- Line Details -->
    <div class="content" *ngIf="!notFound && !isLoading && line">
      <!-- Header -->
      <div class="page-header">
        <div class="header-left">
          <button class="btn-back" (click)="goBack()">‚Üê Powr√≥t</button>
          <h1>Szczeg√≥≈Çy linii: {{ line.name }}</h1>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="card">
          <div class="card-label">ID Linii</div>
          <div class="card-value">{{ line.id }}</div>
        </div>
        <div class="card">
          <div class="card-label">Nazwa</div>
          <div class="card-value">{{ line.name }}</div>
        </div>
        <div class="card">
          <div class="card-label">D≈Çugo≈õƒá trasy</div>
          <div class="card-value">
            <span *ngIf="getLineLength() === 0" class="text-muted">
              Brak danych
            </span>
            <span *ngIf="getLineLength() > 0">
              {{ formatDistance(getLineLength()) }}
            </span>
          </div>
        </div>
        <div class="card">
          <div class="card-label">Liczba przystank√≥w</div>
          <div class="card-value">{{ line.stopIds.length }}</div>
        </div>
        <div class="card card-clickable" (click)="goToCharts()">
          <div class="card-label">Wykresy</div>
          <div class="card-value card-icon">üìä</div>
        </div>
      </div>

      <!-- Stops Section -->
      <div class="section">
        <h2>Przystanki - Kierunek {{ getDirectionLabel(false) }}</h2>
        <div class="table-container" *ngIf="orderedStops.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nr</th>
                <th>ID Przystanku</th>
                <th>Nazwa</th>
                <th>Po≈Ço≈ºenie</th>
                <th>Czas</th>
                <th>Prƒôdko≈õƒá kom.</th>
                <th>Wiata</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stop of orderedStops; let i = index">
                <td>
                  <span class="stop-number">{{ i + 1 }}</span>
                </td>
                <td>{{ stop.id }}</td>
                <td>
                  <strong>{{ stop.name }}</strong>
                </td>
                <td>
                  {{ formatDistance(getDistanceFromStart(stop.id, false)) }}
                </td>
                <td>
                  {{ formatTime(getTravelTime(stop.id, false)) }}
                </td>
                <td>
                  {{ getCommunicationSpeed(stop.id, false) }}
                </td>
                <td>
                  <span
                    class="badge"
                    [class.badge-yes]="stop.hasShelter"
                    [class.badge-no]="!stop.hasShelter"
                  >
                    {{ stop.hasShelter ? "Tak" : "Nie" }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state" *ngIf="orderedStops.length === 0">
          <p>Brak przystank√≥w przypisanych do tej linii.</p>
        </div>
      </div>

      <!-- Reverse Direction Stops Section -->
      <div class="section">
        <h2>Przystanki - Kierunek {{ getDirectionLabel(true) }}</h2>
        <div class="table-container" *ngIf="reversedStops.length > 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nr</th>
                <th>ID Przystanku</th>
                <th>Nazwa</th>
                <th>Po≈Ço≈ºenie</th>
                <th>Czas</th>
                <th>Prƒôdko≈õƒá kom.</th>
                <th>Wiata</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stop of reversedStops; let i = index">
                <td>
                  <span class="stop-number">{{ i + 1 }}</span>
                </td>
                <td>{{ stop.id }}</td>
                <td>
                  <strong>{{ stop.name }}</strong>
                </td>
                <td>
                  {{ formatDistance(getDistanceFromStart(stop.id, true)) }}
                </td>
                <td>
                  {{ formatTime(getTravelTime(stop.id, true)) }}
                </td>
                <td>
                  {{ getCommunicationSpeed(stop.id, true) }}
                </td>
                <td>
                  <span
                    class="badge"
                    [class.badge-yes]="stop.hasShelter"
                    [class.badge-no]="!stop.hasShelter"
                  >
                    {{ stop.hasShelter ? "Tak" : "Nie" }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state" *ngIf="reversedStops.length === 0">
          <p>Brak przystank√≥w przypisanych do tej linii.</p>
        </div>
      </div>

      <!-- Schedule Section -->
      <div class="section">
        <div class="section-header">
          <h2>
            Harmonogram Przejazd√≥w
            <span
              class="trips-count"
              *ngIf="vehicleSchedule.vehicles.length > 0"
            >
              ({{ vehicleSchedule.vehicles.length }} pojazd√≥w,
              {{ getTotalTripsCount() }} przejazd√≥w)
            </span>
          </h2>
          <div class="header-buttons">
            <button
              class="btn-save"
              (click)="saveManually()"
              title="Zapisz harmonogram"
            >
              üíæ Zapisz
            </button>
            <button class="btn-add-vehicle" (click)="openAddVehiclePopup()">
              + Dodaj pojazd
            </button>
          </div>
        </div>
        <p class="section-description">
          <span class="storage-info"
            >üíæ Dane harmonogramu sƒÖ automatycznie ≈Çadowane i zapisywane w
            localStorage</span
          >
          <br />
          Harmonogram przejazd√≥w dla ka≈ºdego pojazdu. Ka≈ºdy pojazd wykonuje
          przejazdy tam i z powrotem z 15-minutowƒÖ przerwƒÖ po ka≈ºdym kierunku.
        </p>

        <!-- Vehicle List -->
        <div
          class="vehicle-container"
          *ngFor="let vehicle of vehicleSchedule.vehicles"
        >
          <div class="vehicle-header">
            <h3>{{ vehicle.name }}</h3>
            <div class="vehicle-actions">
              <button
                class="btn-add-trip-small"
                (click)="openAddTripPopup(vehicle.id)"
              >
                + Dodaj cykl
              </button>
              <button
                class="btn-delete-small"
                (click)="deleteVehicle(vehicle.id)"
                title="Usu≈Ñ pojazd"
              >
                üóëÔ∏è Usu≈Ñ
              </button>
            </div>
          </div>
          <div class="table-container" *ngIf="vehicle.trips.length > 0">
            <table class="data-table schedule-table">
              <thead>
                <tr>
                  <th>Kierunek</th>
                  <th *ngFor="let stopId of getScheduleStopIds()">
                    {{ stopId }}
                  </th>
                  <th>Przerwa do</th>
                  <th>Akcje</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let trip of vehicle.trips; let tripIndex = index">
                  <td>
                    <strong>{{ trip.direction }}</strong>
                  </td>
                  <td *ngFor="let stopId of getScheduleStopIds()">
                    {{ getTripTime(trip, stopId) }}
                  </td>
                  <td>
                    <strong>{{ trip.breakEndTime }}</strong>
                  </td>
                  <td>
                    <button
                      class="btn-delete-trip"
                      (click)="deleteTrip(vehicle.id, tripIndex)"
                      title="Usu≈Ñ ca≈Çy cykl (tam i z powrotem)"
                    >
                      ‚ùå
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="empty-state" *ngIf="vehicle.trips.length === 0">
            <p>Brak przejazd√≥w dla tego pojazdu.</p>
          </div>
        </div>

        <div class="empty-state" *ngIf="vehicleSchedule.vehicles.length === 0">
          <p>Brak pojazd√≥w w harmonogramie.</p>
        </div>
      </div>
    </div>

    <!-- Add Vehicle Popup -->
    <div
      class="popup-overlay"
      *ngIf="showAddVehiclePopup"
      (click)="closeAddVehiclePopup()"
    >
      <div class="popup-content" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h3>Dodaj nowy pojazd</h3>
          <button class="close-btn" (click)="closeAddVehiclePopup()">√ó</button>
        </div>
        <div class="popup-body">
          <p class="popup-info">
            Wprowad≈∫ nazwƒô nowego pojazdu i wybierz przystanek poczƒÖtkowy.
            Pojazd zostanie utworzony z poczƒÖtkowym przejazdem rozpoczynajƒÖcym
            siƒô o 6:00.
          </p>
          <div class="form-group">
            <label for="vehicleName">Nazwa pojazdu:</label>
            <input
              type="text"
              id="vehicleName"
              [(ngModel)]="newVehicleName"
              class="text-input"
              placeholder="np. Pojazd 1"
            />
          </div>
          <div class="form-group">
            <label for="startStop">Przystanek poczƒÖtkowy:</label>
            <select
              id="startStop"
              [(ngModel)]="selectedStartStopId"
              class="select-input"
            >
              <option
                [value]="orderedStops[0].id"
                *ngIf="orderedStops.length > 0"
              >
                {{ orderedStops[0].name }} ({{ orderedStops[0].id }})
              </option>
              <option
                [value]="orderedStops[orderedStops.length - 1].id"
                *ngIf="orderedStops.length > 0"
              >
                {{ orderedStops[orderedStops.length - 1].name }} ({{
                  orderedStops[orderedStops.length - 1].id
                }})
              </option>
            </select>
          </div>
        </div>
        <div class="popup-footer">
          <button class="btn-secondary" (click)="closeAddVehiclePopup()">
            Anuluj
          </button>
          <button class="btn-primary" (click)="addNewVehicle()">
            Dodaj pojazd
          </button>
        </div>
      </div>
    </div>

    <!-- Add Trip Popup -->
    <div
      class="popup-overlay"
      *ngIf="showAddTripPopup"
      (click)="closeAddTripPopup()"
    >
      <div class="popup-content" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h3>Dodaj nowy cykl przejazd√≥w</h3>
          <button class="close-btn" (click)="closeAddTripPopup()">√ó</button>
        </div>
        <div class="popup-body">
          <p class="popup-info">
            Wprowad≈∫ godzinƒô rozpoczƒôcia kolejnego cyklu przejazd√≥w (tam i z
            powrotem) dla wybranego pojazdu.
          </p>
          <div class="form-group">
            <label for="startTime">Godzina rozpoczƒôcia:</label>
            <input
              type="time"
              id="startTime"
              [(ngModel)]="newTripStartTime"
              [min]="getMinStartTimeForVehicle(selectedVehicleId)"
              class="time-input"
            />
            <p class="help-text">
              Minimalna godzina:
              {{ getMinStartTimeForVehicle(selectedVehicleId) }}
            </p>
          </div>
        </div>
        <div class="popup-footer">
          <button class="btn-secondary" (click)="closeAddTripPopup()">
            Anuluj
          </button>
          <button class="btn-primary" (click)="addNewTrip()">Dodaj cykl</button>
        </div>
      </div>
    </div>
  </div>
</div>
